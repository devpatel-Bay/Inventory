<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Hotel Inventory & Sales Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root { --bg:#f6f6f7; --card:#fff; --border:#e5e7eb; --text:#111; --muted:#6b7280; --ok:#16a34a; --err:#dc2626; --warn:#f59e0b;}
  * { box-sizing: border-box; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); color:var(--text); }
  .container { max-width: 1100px; margin: 0 auto; padding: 16px; }
  header { display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
  h1 { font-size: 22px; font-weight: 700; margin:0; }
  .sub { font-size:12px; color:var(--muted); }
  .btn { border:1px solid var(--border); background:#fff; padding:8px 12px; border-radius:14px; font-size:14px; cursor:pointer; }
  .btn.primary { background:#111; color:#fff; }
  .btn:active { transform: scale(.98); }
  .card { background:var(--card); border:1px solid var(--border); border-radius:18px; padding:16px; box-shadow: 0 1px 2px rgba(0,0,0,.03); margin-top:16px; }
  .card-title { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; flex-wrap:wrap; gap:8px; }
  .input { width:100%; border:1px solid var(--border); border-radius:12px; padding:10px; font-size:14px; }
  .input[readonly] { background:#fafafa; cursor:pointer; }
  .input[type="number"] { text-align:right; }
  table { width:100%; border-collapse:collapse; font-size:14px; }
  thead tr { background:#f3f4f6; }
  th, td { text-align:left; padding:8px; border-bottom:1px solid var(--border); vertical-align: middle; }
  th.right, td.right { text-align:right; }
  .small { font-size:12px; color:var(--muted); }
  .pill { display:inline-flex; border:1px solid var(--border); border-radius:999px; padding:2px 8px; font-size:12px; color:#374151; }
  .row { display:flex; gap:12px; }
  .grow { flex:1 1 auto; }
  .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; place-items:center; padding:16px; z-index:1000; }
  .modal { background:#fff; border:1px solid var(--border); border-radius:16px; width:100%; max-width:620px; padding:16px; box-shadow: 0 6px 24px rgba(0,0,0,.12); }
  .toast { position:fixed; top:12px; right:12px; z-index:2000; padding:10px 14px; border-radius:12px; color:#fff; font-weight:600; display:none; }
  .toast.ok { background:var(--ok); }
  .toast.err { background:var(--err); }
  .toast.warn { background:var(--warn); color:#111; }
  #scanStrip { display:flex; gap:6px; flex-wrap:wrap; margin-top:8px; }
  .chip { border:1px solid var(--border); background:#fff; border-radius:999px; padding:4px 8px; font-size:12px; }
  .chip.ok { border-color:#bbf7d0; background:#f0fdf4; }
  .chip.err { border-color:#fecaca; background:#fef2f2; }
  .banner { background:#fff7ed; border:1px solid #fed7aa; color:#7c2d12; padding:8px 12px; border-radius:12px; margin-top:8px; display:none; }

  /* Mobile-friendly tweaks */
  @media (max-width: 640px) {
    .container { padding: 12px; }
    h1 { font-size: 18px; }
    .btn { padding: 8px 10px; font-size: 13px; }
    table { font-size: 12px; }
    th, td { padding: 6px; }
    .row { flex-wrap: wrap; }
    header > div:last-child { width: 100%; display:flex; gap:8px; }
    header > div:last-child .btn { flex:1 1 50%; }
    #frontView .card .row > .grow,
    #frontView .card .row > div[style*="width:320px"] { width:100% !important; }
    .pill { font-size: 11px; padding: 2px 6px; }
  }
</style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Hotel Inventory & Sales Tracker</h1>
        <div class="sub">Local time (America/Chicago): <b id="cstClock">--:--:--</b></div>
      </div>
      <div>
        <button id="frontBtn" class="btn primary">Front Desk (Scan)</button>
        <button id="adminBtn" class="btn">Admin</button>
      </div>
    </header>

    <div class="row" style="align-items:center; justify-content:space-between; margin-top:8px;">
      <div class="small">Hotel: <b id="hotelBadge">—</b></div>
      <!-- Setup removed from front desk view -->
    </div>

    <div id="focusBanner" class="banner">Scanner is inactive until you open a Scan Session. Click the input below to start.</div>

    <!-- Front Desk -->
    <section id="frontView" class="card">
      <div class="card-title">
        <h3 style="margin:0; font-size:16px; font-weight:600">Scan Items</h3>
        <div class="small">Open a Scan Session to capture barcodes. Keyboard shortcut disabled by policy.</div>
      </div>

      <div class="row">
        <div class="grow">
          <div class="small" style="margin-bottom:6px">Barcode Input (opens scan session)</div>
          <input id="scanInput" class="input" placeholder="Click here to start a Scan Session" readonly />
          <div id="lastScan" class="small" style="margin-top:8px"></div>
        </div>
        <div style="width:320px">
          <div class="small" style="margin-bottom:6px">Quick Search</div>
          <input id="filterInput" class="input" placeholder="Filter by name or barcode" />
        </div>
      </div>

      <div id="scanStrip" aria-live="polite"></div>

      <div class="row" style="gap:16px; margin-top:12px;">
        <div class="card grow" style="margin-top:0;">
          <div class="small">Units Sold Today</div>
          <div id="unitsSold" style="font-size:18px; font-weight:600">0</div>
        </div>
        <div class="card grow" style="margin-top:0;">
          <div class="small">Revenue (Price × Units)</div>
          <div id="revenueToday" style="font-size:18px; font-weight:600">$0.00</div>
        </div>
        <div class="card" style="margin-top:0;">
          <div class="small">Actions</div>
          <button id="undoOpen" class="btn" style="margin-top:6px;">Undo a Posted Item…</button>
        </div>
      </div>

      <!-- Today’s Scan Log -->
      <div class="card" style="margin-top:16px;">
        <div class="card-title">
          <h3 style="margin:0; font-size:16px; font-weight:600">Today’s Scan Log</h3>
        </div>
        <div style="overflow:auto">
          <table id="logTable">
            <thead>
              <tr>
                <th>Product</th>
                <th>Barcode</th>
                <th class="right">UNITS SOLD TODAY</th>
                <th class="right">REVENUE TODAY</th>
                <th class="right">LAST SCAN</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Inventory ranked -->
      <div class="card" style="margin-top:16px;">
        <div class="card-title">
          <h3 style="margin:0; font-size:16px; font-weight:600">Inventory (ranked by Units Sold Today)</h3>
        </div>
        <div style="overflow:auto">
          <table id="frontTable">
            <thead>
              <tr>
                <th>Product</th>
                <th class="right">PRICE SOLD</th>
                <th class="right">STARTING INVENTORY</th>
                <th class="right">UNITS SOLD TODAY</th>
                <th class="right">ENDING INVENTORY</th>
                <th class="right">PRICE SOLD × UNITS SOLD</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Admin -->
    <section id="adminView" class="card" style="display:none">
      <div class="card-title">
        <h3 style="margin:0; font-size:16px; font-weight:600">Admin Controls</h3>
        <div class="row">
          <button id="addProduct" class="btn">Add Product</button>
          <button id="exportCSV" class="btn">Export CSV</button>
          <label class="btn" style="cursor:pointer">Import CSV<input id="importCSV" type="file" accept=".csv" style="display:none" /></label>
          <button id="clearToday" class="btn">Clear Today Sales</button>
          <button id="syncCatalog" class="btn">Sync Catalog → Sheet</button>
          <button id="changePass" class="btn">Change Password</button>
        </div>
      </div>

      <!-- Settings moved here -->
      <div class="card" style="margin-top:12px;">
        <div class="card-title">
          <h3 style="margin:0; font-size:16px; font-weight:600">Settings</h3>
        </div>
        <div class="row" style="align-items:center; margin-bottom:8px">
          <label style="width:160px" class="small">Hotel name</label>
          <input id="hotelInput" class="input grow" />
        </div>
        <div class="row" style="align-items:center">
          <label style="width:160px" class="small">Apps Script URL</label>
          <input id="gasInput" class="input grow" placeholder="https://script.google.com/macros/s/.../exec" />
        </div>
        <div id="setupMsg" class="small" style="margin-top:8px"></div>
        <div class="row" style="justify-content:flex-end; margin-top:12px">
          <button id="saveSetup" class="btn">Save</button>
          <button id="testPing" class="btn">Test Ping</button>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <input id="adminFilter" class="input grow" placeholder="Filter by name, barcode, or category" />
      </div>

      <div style="overflow:auto">
        <table id="adminTable">
          <thead>
            <tr>
              <th>Product</th>
              <th>Barcode</th>
              <th>Category</th>
              <th class="right">PRICE SOLD</th>
              <th class="right">VENDOR COST</th>
              <th class="right">STARTING INVENTORY</th>
              <th class="right">UNITS SOLD TODAY</th>
              <th class="right">ENDING INVENTORY</th>
              <th class="right">PRICE SOLD × UNITS SOLD</th>
              <th class="right">ENDING INVENTORY (×) VENDOR COST</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- Admin Password Modal -->
  <div id="passModal" class="modal-backdrop">
    <div class="modal">
      <h3 style="margin-top:0">Enter Admin Password</h3>
      <input id="passField" class="input" type="password" placeholder="Password (default: admin123)" />
      <div id="passErr" style="color:#dc2626; margin-top:6px; font-size:14px"></div>
      <div class="row" style="justify-content:flex-end; margin-top:12px">
        <button id="passCancel" class="btn">Cancel</button>
        <button id="passOk" class="btn primary">Unlock</button>
      </div>
    </div>
  </div>

  <!-- Scan Session Modal -->
  <div id="sessionModal" class="modal-backdrop">
    <div class="modal">
      <h3 style="margin-top:0">Scan Session</h3>
      <div class="small" style="margin-bottom:6px">Scanner is active now. Scan items; press Enter after each barcode.</div>
      <div id="sessionHint" class="small" style="margin-bottom:8px">Waiting for first scan…</div>
      <div style="max-height:260px; overflow:auto; border:1px solid var(--border); border-radius:12px;">
        <table style="width:100%; border-collapse:collapse;">
          <thead><tr><th style="padding:6px 8px;">Product</th><th>Barcode</th><th class="right" style="padding:6px 8px;">Qty</th><th class="right" style="padding:6px 8px;">Revenue</th></tr></thead>
          <tbody id="sessionBody"></tbody>
        </table>
      </div>
      <div class="row" style="justify-content:flex-end; margin-top:12px">
        <button id="sessionCancel" class="btn">Cancel</button>
        <button id="sessionPost" class="btn primary">Post</button>
      </div>
    </div>
  </div>

  <!-- Undo Picker Modal -->
  <div id="undoModal" class="modal-backdrop">
    <div class="modal">
      <h3 style="margin-top:0">Undo a Posted Item</h3>
      <div class="small" style="margin-bottom:8px">Select one of today’s posted entries to remove.</div>
      <div style="max-height:300px; overflow:auto; border:1px solid var(--border); border-radius:12px;">
        <table style="width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              <th></th>
              <th>Time</th>
              <th>Product</th>
              <th>Barcode</th>
              <th class="right">Qty</th>
            </tr>
          </thead>
          <tbody id="undoBody"></tbody>
        </table>
      </div>
      <div class="row" style="justify-content:flex-end; margin-top:12px">
        <button id="undoCancel" class="btn">Cancel</button>
        <button id="undoConfirm" class="btn primary">Remove Selected</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
  /*************** REQUIRED: Hard-coded defaults ****************/
  // TODO: replace both with your live values (these are used automatically on every device)
  const DEFAULT_HOTEL_NAME = 'Hampton Inn Cable Ranch';
  const DEFAULT_GAS_URL    = 'https://script.google.com/macros/s/AKfycbwPQGVTtCNZgAhSkrrpnpmQuneSoueJJiixAzMEmoNBPLda9ZgjzRhDlO1oyAp5leTMfw/exec';

  /******** Storage keys ********/
  const LS_INV="hotel_inventory_v1", LS_SALES="hotel_sales_v1", LS_ADMIN_PASS="hotel_admin_pass_v1";
  const LS_QUEUE="sales_queue_v1", LS_LAST_DAY="last_open_day_v1", LS_HOTEL="hotel_name_v1", LS_GAS="gas_webapp_url_v1";
  const LS_CLEARED_ON = "cleared_on_cst_v1";

  /******** Helpers ********/
  const currency = n => isNaN(n) ? "-" : Number(n).toLocaleString(undefined,{style:"currency",currency:"USD"});
  const localDateKey = d => { const dt = (d instanceof Date)? d : new Date(d); return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,"0")}-${String(dt.getDate()).padStart(2,"0")}`; };
  const todayKey = () => localDateKey(new Date());
  const loadJSON = (k,f)=>{ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):f; }catch{ return f; }};
  const saveJSON = (k,v)=>localStorage.setItem(k,JSON.stringify(v));
  const escapeHtml = s => String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  function fmtTime(ts){ try{ const d=new Date(ts); return d.toLocaleTimeString('en-US',{hour:'2-digit', minute:'2-digit', second:'2-digit'}) }catch{ return '-'; } }
  function fmtTimeCST(date){
    return new Intl.DateTimeFormat('en-US',{ timeZone:'America/Chicago', year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit' }).format(date);
  }
  function todayKeyCST(){
    return new Intl.DateTimeFormat('en-CA', { timeZone:'America/Chicago', year:'numeric', month:'2-digit', day:'2-digit' }).format(new Date());
  }
  function nowCSTParts(){
    const parts = new Intl.DateTimeFormat('en-US', { timeZone:'America/Chicago', hour:'2-digit', minute:'2-digit', hour12:false }).formatToParts(new Date());
    const get = k => parts.find(p => p.type===k)?.value || '00';
    return { hour:get('hour'), minute:get('minute') };
  }

  /******** App state (Sheet is the source of truth) ********/
  let inventory = loadJSON(LS_INV, []);   // filled by Sheet
  let sales     = loadJSON(LS_SALES, []); // filled by Sheet
  let adminPass = localStorage.getItem(LS_ADMIN_PASS) || "admin123";

  // Fallback seed (only if pull fails AND cache empty)
  const SEED_FALLBACK = [
    { id: crypto.randomUUID(), barcode:"0123456789012", name:"Bottled Water 16oz", priceSold:1.99, vendorCost:0.45, startingInventory:50, category:"Drinks" },
    { id: crypto.randomUUID(), barcode:"1234567890123", name:"Chips - Classic",    priceSold:2.49, vendorCost:0.65, startingInventory:40, category:"Snacks" },
    { id: crypto.randomUUID(), barcode:"2345678901234", name:"Chocolate Bar",      priceSold:2.99, vendorCost:0.85, startingInventory:35, category:"Snacks" }
  ];
  let initialSynced = false;

  // Seed defaults per-device for hotel name + GAS URL
  if (!localStorage.getItem(LS_HOTEL)) localStorage.setItem(LS_HOTEL, DEFAULT_HOTEL_NAME);
  if (!localStorage.getItem(LS_GAS))   localStorage.setItem(LS_GAS,   DEFAULT_GAS_URL);

  // Preserve last-day stamp
  (function(){ const t=todayKey(); const last=localStorage.getItem(LS_LAST_DAY); localStorage.setItem(LS_LAST_DAY,t); })();

  /******** DOM refs ********/
  const frontBtn = document.getElementById('frontBtn');
  const adminBtn = document.getElementById('adminBtn');
  const frontView = document.getElementById('frontView');
  const adminView = document.getElementById('adminView');

  const cstClock = document.getElementById('cstClock');

  const scanInput = document.getElementById('scanInput');
  const filterInput = document.getElementById('filterInput');
  const lastScan = document.getElementById('lastScan');
  const frontTbody = document.querySelector('#frontTable tbody');
  const logTbody = document.querySelector('#logTable tbody');
  const unitsSoldEl = document.getElementById('unitsSold');
  const revenueTodayEl = document.getElementById('revenueToday');
  const focusBanner = document.getElementById('focusBanner');
  const scanStrip = document.getElementById('scanStrip');

  const adminFilter = document.getElementById('adminFilter');
  const adminTbody = document.querySelector('#adminTable tbody');

  const hotelBadge = document.getElementById('hotelBadge');

  // Admin settings refs
  const hotelInput = document.getElementById('hotelInput');
  const gasInput = document.getElementById('gasInput');
  const setupMsg = document.getElementById('setupMsg');
  const saveSetup = document.getElementById('saveSetup');
  const testPing = document.getElementById('testPing');

  const passModal = document.getElementById('passModal');
  const passField = document.getElementById('passField');
  const passErr = document.getElementById('passErr');
  const passCancel = document.getElementById('passCancel');
  const passOk = document.getElementById('passOk');

  const addProduct = document.getElementById('addProduct');
  const exportCSV = document.getElementById('exportCSV');
  const importCSV = document.getElementById('importCSV');
  const clearToday = document.getElementById('clearToday');
  const syncCatalog = document.getElementById('syncCatalog');

  // Scan Session modal
  const sessionModal = document.getElementById('sessionModal');
  const sessionBody  = document.getElementById('sessionBody');
  const sessionHint  = document.getElementById('sessionHint');
  const sessionCancel= document.getElementById('sessionCancel');
  const sessionPost  = document.getElementById('sessionPost');

  /******** Settings helpers (defaults + overrides) ********/
  const getHotelName = ()=> localStorage.getItem(LS_HOTEL) || DEFAULT_HOTEL_NAME;
  const setHotelName = n => localStorage.setItem(LS_HOTEL, n || DEFAULT_HOTEL_NAME);
  const getGAS = ()=> localStorage.getItem(LS_GAS) || DEFAULT_GAS_URL;
  const setGAS = u => localStorage.setItem(LS_GAS, u || DEFAULT_GAS_URL);
  function refreshBadges(){ hotelBadge.textContent = getHotelName(); }

  /******** Networking ********/
  const loadQueue = ()=>loadJSON(LS_QUEUE,[]);
  const saveQueue = q=>saveJSON(LS_QUEUE,q);
  async function sendToGAS(evt){
    const url = getGAS(); if(!url) return true;
    try{ await fetch(url, { method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify(evt), mode:"no-cors" }); return true; }
    catch(e){ return false; }
  }
  async function postBatch(entries){
    const url = getGAS(); if(!url) return true;
    try{
      await fetch(url, { method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify({ type:"batch", payload: entries }), mode:"no-cors" });
      return true;
    }catch(e){ return false; }
  }
  async function flushQueue(){
    const url=getGAS(); if(!url) return;
    const q=loadQueue(); if(!q.length) return;
    const still=[];
    for(const evt of q){
      const ok = evt?.type==="batch" ? await postBatch(evt.payload) : await sendToGAS(evt);
      if(!ok) still.push(evt);
    }
    saveQueue(still);
  }
  window.addEventListener('online', flushQueue);

  /******** Pull from server (authoritative) ********/
  async function pullTodayFromServer(forceToast=false){
    const url = getGAS();
    if(!url) return false;

    try{
      const resp = await fetch(url + '?summary=today', { cache: 'no-store' });
      const data = await resp.json();
      if(!data?.ok) return false;

      // Catalog → inventory
      const newInv = (data.catalog||[]).map(p => ({
        id: crypto.randomUUID(),
        barcode: String(p.barcode||''),
        name: p.name || '',
        priceSold: Number(p.priceSold)||0,
        vendorCost: Number(p.vendorCost)||0,
        startingInventory: Number(p.startingInventory)||0,
        category: ''
      }));
      if(newInv.length){
        inventory = newInv;
        saveJSON(LS_INV, inventory);
      }

      // Sales(today) → replace only today
      const today = todayKey();
      const rows = (data.salesTodayRaw||[]);
      const serverToday = rows.map(r => ({
        id: String(r.id || crypto.randomUUID()),
        barcode: String(r.barcode || ''),
        qty: Number(r.qty)||0,
        ts: r.ts || new Date().toISOString(),
        ld: today
      }));
      const nonToday = (sales||[]).filter(s => (s.ld ? s.ld !== today : localDateKey(s.ts) !== today));
      sales = [...nonToday, ...serverToday];
      saveJSON(LS_SALES, sales);

      // Hotel name (if present)
      if ((data.hotels||[]).length) setHotelName(data.hotels[0]);

      refreshBadges();
      renderFront(); renderScanLog(); if (adminView.style.display !== 'none') renderAdmin();
      if (forceToast) showToast('Synced from Google Sheets', 'ok');
      initialSynced = true;
      return true;
    }catch(e){
      return false;
    }
  }

  /******** Local-day stamping ********/
  function ensureLocalDayOnSales(){ let changed=false; sales.forEach(s=>{ if(!s.ld){ s.ld=localDateKey(s.ts); changed=true; } }); if(changed) saveJSON(LS_SALES,sales); }

  /******** Aggregations ********/
  function todaysAggregate(){
    const day = todayKey();
    const byItem = new Map();
    for(const s of sales){
      const isToday = s.ld ? (s.ld===day) : (localDateKey(s.ts)===day);
      if(!isToday) continue;
      const bc = s.barcode;
      const prod = inventory.find(p=>p.barcode===bc);
      const name = prod?.name || '(Unknown)';
      const price = prod?.priceSold || 0;
      const rec = byItem.get(bc) || { name, price, sold:0, revenue:0, lastTs:null, barcode: bc };
      rec.sold += (s.qty||0);
      rec.revenue += (price*(s.qty||0));
      if(!rec.lastTs || new Date(s.ts) > new Date(rec.lastTs)) rec.lastTs = s.ts;
      byItem.set(bc, rec);
    }
    return Array.from(byItem.values());
  }
  function todaySalesMap(){ const m=new Map(); todaysAggregate().forEach(r=> m.set(r.barcode, r.sold)); return m; }

  /******** Toast + sounds ********/
  const toastEl = document.getElementById('toast');
  function showToast(msg, kind='ok', ms=1200){ toastEl.textContent = msg; toastEl.className = `toast ${kind}`; toastEl.style.display = 'block'; setTimeout(()=> toastEl.style.display='none', ms); }
  function beepOk(){ tone(880, 80); }
  function beepErr(){ tone(220, 160); }
  function tone(freq, dur){ try{ const ctx = new (window.AudioContext||window.webkitAudioContext)(); const o = ctx.createOscillator(); const g = ctx.createGain(); o.type='sine'; o.frequency.value=freq; o.connect(g); g.connect(ctx.destination); g.gain.setValueAtTime(0.001, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.1, ctx.currentTime+0.01); o.start(); setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.02); o.stop(ctx.currentTime+0.03); ctx.close(); }, dur);}catch{} }

  /******** Renderers ********/
  function renderScanLog(){
    const rows = todaysAggregate().sort((a,b)=> b.sold - a.sold || (new Date(b.lastTs)-new Date(a.lastTs)));
    logTbody.innerHTML="";
    if(!rows.length){ const tr=document.createElement('tr'); tr.innerHTML = `<td colspan="5" class="small">No scans yet today.</td>`; logTbody.appendChild(tr); return; }
    for(const r of rows){
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(r.name)}</td>
        <td><span class="pill">${escapeHtml(r.barcode||'')}</span></td>
        <td class="right">${r.sold}</td>
        <td class="right">${currency(r.revenue)}</td>
        <td class="right">${r.lastTs? fmtTime(r.lastTs): '-'}</td>
      `;
      logTbody.appendChild(tr);
    }
  }
  function renderFront(){
    const query = (filterInput.value||"").trim().toLowerCase();
    const map = todaySalesMap();
    const items = inventory.map(p=>{
      const sold = map.get(p.barcode)||0;
      const end = Math.max(0,(p.startingInventory||0)-sold);
      const rev = (p.priceSold||0)*sold;
      return { p, sold, end, rev };
    }).filter(row=>{
      if(!query) return true;
      return row.p.name.toLowerCase().includes(query) || (row.p.barcode||"").toLowerCase().includes(query);
    }).sort((a,b)=> b.sold - a.sold);

    frontTbody.innerHTML = "";
    let totalUnits=0, totalRev=0;
    for(const row of items){
      const {p, sold, end, rev} = row;
      totalUnits += sold; totalRev += rev;
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td><div style="display:flex;align-items:center;gap:8px"><div style="font-weight:600">${escapeHtml(p.name)}</div><span class="pill">${escapeHtml(p.barcode||"no barcode")}</span></div></td>
        <td class="right">${currency(p.priceSold)}</td>
        <td class="right">${p.startingInventory||0}</td>
        <td class="right">${sold}</td>
        <td class="right">${end}</td>
        <td class="right">${currency(rev)}</td>
      `;
      frontTbody.appendChild(tr);
    }
    unitsSoldEl.textContent = String(totalUnits);
    revenueTodayEl.textContent = currency(totalRev);
  }
  function renderAdmin(){
    const q=(adminFilter.value||"").trim().toLowerCase();
    const map = todaySalesMap();
    adminTbody.innerHTML = "";
    for(const p of inventory){
      if(q && !(p.name.toLowerCase().includes(q) || (p.barcode||"").toLowerCase().includes(q) || (p.category||"").toLowerCase().includes(q))) continue;
      const sold = map.get(p.barcode)||0;
      const end = Math.max(0,(p.startingInventory||0)-sold);
      const rev = (p.priceSold||0)*sold;
      const endCost = (p.vendorCost||0)*end;
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td><input class="input" value="${escapeHtml(p.name)}" data-f="name" /></td>
        <td><input class="input" value="${escapeHtml(p.barcode||"")}" data-f="barcode" /></td>
        <td><input class="input" value="${escapeHtml(p.category||"")}" data-f="category" /></td>
        <td class="right"><input class="input" type="number" step="0.01" value="${Number(p.priceSold)||0}" data-f="priceSold" /></td>
        <td class="right"><input class="input" type="number" step="0.01" value="${Number(p.vendorCost)||0}" data-f="vendorCost" /></td>
        <td class="right"><input class="input" type="number" value="${Number(p.startingInventory)||0}" data-f="startingInventory" /></td>
        <td class="right">${sold}</td>
        <td class="right">${end}</td>
        <td class="right">${currency(rev)}</td>
        <td class="right">${currency(endCost)}</td>
        <td class="right"><button class="btn" data-act="del">Delete</button></td>
      `;
      tr.querySelectorAll('input').forEach(inp=>{
        inp.addEventListener('change', ()=>{
          const f=inp.getAttribute('data-f');
          let val=inp.value;
          if(f==='priceSold'||f==='vendorCost') val=parseFloat(val)||0;
          if(f==='startingInventory') val=parseInt(val)||0;
          p[f]=val; saveJSON(LS_INV, inventory); renderFront(); renderScanLog(); renderAdmin();
        });
      });
      tr.querySelector('[data-act="del"]').addEventListener('click', ()=>{
        if(!confirm('Remove this product?')) return;
        inventory=inventory.filter(x=>x.id!==p.id);
        saveJSON(LS_INV, inventory); renderFront(); renderScanLog(); renderAdmin();
      });
      adminTbody.appendChild(tr);
    }
  }

  /******** Filters ********/
  filterInput.addEventListener('input', ()=>{ renderFront(); renderScanLog(); });
  adminFilter.addEventListener('input', renderAdmin);

  /******** Catalog mgmt ********/
  addProduct.addEventListener('click', ()=>{
    inventory.push({ id:crypto.randomUUID(), barcode:"", name:"New Product", priceSold:0, vendorCost:0, startingInventory:0, category:"" });
    saveJSON(LS_INV, inventory); renderFront(); renderScanLog(); renderAdmin();
  });
  exportCSV.addEventListener('click', ()=>{
    const headers=["barcode","name","priceSold","vendorCost","startingInventory","category"];
    const body=inventory.map(p=>[p.barcode,p.name,p.priceSold,p.vendorCost,p.startingInventory,p.category||""].map(x=>String(x).replaceAll(",","")).join(",")).join("\n");
    const csv=headers.join(",")+"\n"+body;
    const blob=new Blob([csv],{type:"text/csv"}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=`inventory_${todayKey()}.csv`; a.click(); URL.revokeObjectURL(url);
  });
  importCSV.addEventListener('change', (ev)=>{
    const f=ev.target.files?.[0]; if(!f) return;
    const r=new FileReader(); r.onload=()=>{
      const text=String(r.result||""); const rows=text.split(/\r?\n/).filter(Boolean); if(!rows.length) return;
      const headers=rows[0].split(",").map(h=>h.trim()); const idx=k=>headers.indexOf(k);
      const out=[];
      for(let i=1;i<rows.length;i++){
        const cols=rows[i].split(",");
        out.push({ id: crypto.randomUUID(), barcode: cols[idx("barcode")]?.trim() || "", name: cols[idx("name")]?.trim() || "",
          priceSold: parseFloat(cols[idx("priceSold")]) || 0, vendorCost: parseFloat(cols[idx("vendorCost")]) || 0,
          startingInventory: parseInt(cols[idx("startingInventory")]) || 0, category: cols[idx("category")]?.trim() || "" });
      }
      if(out.length){ inventory=out; saveJSON(LS_INV, inventory); renderFront(); renderScanLog(); renderAdmin(); }
      ev.target.value="";
    };
    r.readAsText(f);
  });
  clearToday.addEventListener('click', ()=>{
    if(!confirm("Clear today’s sales (today only)?")) return;
    const day=todayKey(); sales=sales.filter(s=> (s.ld ? s.ld !== day : localDateKey(s.ts)!==day) ); saveJSON(LS_SALES,sales);
    renderFront(); renderScanLog(); renderAdmin();
  });
  syncCatalog.addEventListener('click', async ()=>{
    const url=getGAS(); if(!url){ alert("Add Apps Script URL in Settings first."); return; }
    const payload=inventory.map(p=>({ barcode:p.barcode||"", name:p.name||"", priceSold:p.priceSold||0, vendorCost:p.vendorCost||0, startingInventory:p.startingInventory||0 }));
    await fetch(url,{ method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify({type:"catalog", payload}), mode:"no-cors" });
    alert("Catalog sync sent. Check the 'Catalog' tab.");
    await pullTodayFromServer(true);   // re-pull authoritative snapshot
  });

  /******** Tabs + admin auth ********/
  frontBtn.addEventListener('click', ()=>{ frontBtn.classList.add('primary'); adminBtn.classList.remove('primary'); frontView.style.display="block"; adminView.style.display="none"; });
  adminBtn.addEventListener('click', ()=>{ passErr.textContent=""; passField.value=""; passModal.style.display="grid"; });
  passCancel.addEventListener('click', ()=> passModal.style.display="none");
  passOk.addEventListener('click', ()=>{
    if(passField.value===localStorage.getItem(LS_ADMIN_PASS) || passField.value===adminPass){
      passModal.style.display="none";
      frontBtn.classList.remove('primary'); adminBtn.classList.add('primary');
      frontView.style.display="none"; adminView.style.display="block";
      hotelInput.value = getHotelName();
      gasInput.value = getGAS();
      setupMsg.textContent = '';
      renderAdmin();
    } else { passErr.textContent="Incorrect password"; }
  });
  document.getElementById('changePass').addEventListener('click', ()=>{
    const cur=prompt("Current password:"); if(cur!==(localStorage.getItem(LS_ADMIN_PASS)||adminPass)) return alert("Incorrect.");
    const next=prompt("New password:"); if(!next) return;
    adminPass=next; localStorage.setItem(LS_ADMIN_PASS, adminPass); alert("Password updated.");
  });

  /******** Settings (Admin) ********/
  saveSetup.addEventListener('click', async ()=>{
    setHotelName(hotelInput.value.trim());
    setGAS(gasInput.value.trim());
    refreshBadges();
    setupMsg.textContent = 'Saved!';
    await pullTodayFromServer(true);   // pull immediately with new settings
  });
  testPing.addEventListener('click', async ()=>{
    const url=getGAS(); if(!url){ setupMsg.textContent="Paste your Web App URL first."; return; }
    setupMsg.textContent="Sending test ping…";
    const ok = await sendToGAS({ type:"sale", payload:{ id: crypto.randomUUID(), ts:new Date().toISOString(), hotel:getHotelName(), barcode:"TEST", name:"Ping", priceSold:0, qty:0, revenue:0 }});
    setupMsg.textContent = ok ? "Ping sent (check Sales tab)" : "Ping failed (check deployment/permissions).";
  });

  /************ Scanner (session only) ************/
  const SCAN_DEBOUNCE_MS = 250;
  const recentScanTimes = new Map();
  function shouldAcceptScan(code){
    const now = Date.now();
    const last = recentScanTimes.get(code) || 0;
    if (now - last < SCAN_DEBOUNCE_MS) return false;
    recentScanTimes.set(code, now);
    return true;
  }
  let buffer = ''; let bufTimer = null; const INTERVAL = 50;
  document.addEventListener('keydown', (e)=>{
    const inSession = sessionModal.style.display === 'grid';
    if(!inSession) return;
    if(e.key==='Enter' || e.key==='NumpadEnter'){
      const code = buffer.trim(); buffer = '';
      if(code){ sessionScan(code); }
      e.preventDefault();
      return;
    }
    if(e.key.length===1){
      buffer += e.key;
      clearTimeout(bufTimer);
      bufTimer = setTimeout(()=>{ buffer=''; }, INTERVAL);
    }
  });

  function nudgeFocusBanner(){
    focusBanner.style.display = 'block';
    setTimeout(()=> focusBanner.style.display='none', 1500);
  }

  /******** Scan Session ONLY ********/
  let sessionMap = new Map();
  function openSession(){
    sessionMap = new Map();
    sessionHint.textContent = 'Waiting for first scan…';
    sessionBody.innerHTML = '';
    sessionModal.style.display = 'grid';
  }
  function closeSession(){ sessionModal.style.display = 'none'; }
  function sessionScan(code){
    const prod=inventory.find(p=>p.barcode===code);
    if(!prod){ addChip(`Unknown ${code}`, 'err'); beepErr(); showToast('Unknown barcode', 'err'); return; }
    if(!shouldAcceptScan(code)) return;
    const cur = sessionMap.get(code) || 0;
    sessionMap.set(code, cur+1);
    sessionHint.textContent = 'Scanning…';
    renderSessionTable();
    beepOk(); lastScan.textContent = `Scanned: ${prod.name} (${code})`;
  }
  function renderSessionTable(){
    sessionBody.innerHTML = '';
    let total=0, rev=0;
    for(const [bc, qty] of sessionMap.entries()){
      const p = inventory.find(x=>x.barcode===bc);
      const r = (p?.priceSold||0)*qty;
      total += qty; rev += r;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td style="padding:6px 8px;">${escapeHtml(p?.name||'(Unknown)')}</td>
        <td><span class="pill">${escapeHtml(bc)}</span></td>
        <td class="right" style="padding:6px 8px;">${qty}</td>
        <td class="right" style="padding:6px 8px;">${currency(r)}</td>`;
      sessionBody.appendChild(tr);
    }
    if(sessionMap.size===0){
      const tr=document.createElement('tr');
      tr.innerHTML = `<td colspan="4" class="small" style="padding:6px 8px;">No items yet.</td>`;
      sessionBody.appendChild(tr);
    }else{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td colspan="2" style="padding:6px 8px; text-align:right;"><b>Totals</b></td>
        <td class="right" style="padding:6px 8px;"><b>${total}</b></td>
        <td class="right" style="padding:6px 8px;"><b>${currency(rev)}</b></td>`;
      sessionBody.appendChild(tr);
    }
  }
  sessionCancel.addEventListener('click', ()=> closeSession());
  sessionPost.addEventListener('click', async ()=>{
    if (sessionMap.size === 0) { closeSession(); return; }
    const now = new Date(); const ts = now.toISOString(); const hotel = getHotelName();
    const entries = [];
    for (const [bc, qty] of sessionMap.entries()){
      const p = inventory.find(x=>x.barcode===bc); if(!p) continue;
      entries.push({ id: crypto.randomUUID(), ts, hotel, barcode: bc, name: p.name, priceSold: p.priceSold||0, qty, revenue: (p.priceSold||0)*qty });
    }
    const ld = localDateKey(now);
    for (const e of entries) sales.push({ id:e.id, barcode:e.barcode, qty:e.qty, ts:e.ts, ld });
    saveJSON(LS_SALES, sales);
    renderFront(); renderScanLog();
    closeSession(); showToast('Session posted', 'ok');

    const ok = await postBatch(entries);
    if(!ok){ const q=loadQueue(); q.push({type:"batch", payload:entries}); saveQueue(q); }
    else { 
      await flushQueue(); 
      await pullTodayFromServer(true);   // authoritative refresh
    }
  });
  scanInput.addEventListener('click', ()=>{ openSession(); nudgeFocusBanner(); });
  function addChip(txt, kind='ok'){
    const span=document.createElement('span'); span.className = `chip ${kind==='err'?'err':'ok'}`; span.textContent = txt; scanStrip.prepend(span);
    const max=12; while(scanStrip.children.length>max){ scanStrip.removeChild(scanStrip.lastChild); }
  }

  /******** Undo Picker ********/
  function buildUndoTable(){
    const day = todayKey();
    const todayItems = sales.filter(s=> (s.ld?s.ld===day:localDateKey(s.ts)===day))
                            .sort((a,b)=> new Date(b.ts)-new Date(a.ts));
    undoBody.innerHTML = '';
    if(!todayItems.length){
      const tr=document.createElement('tr'); tr.innerHTML = `<td colspan="5" class="small" style="padding:6px 8px;">No posted items today.</td>`;
      undoBody.appendChild(tr); return;
    }
    for(const s of todayItems){
      const p = inventory.find(x=>x.barcode===s.barcode);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="radio" name="undoPick" value="${escapeHtml(s.id)}" /></td>
        <td>${fmtTime(s.ts)}</td>
        <td>${escapeHtml(p?.name||'(Unknown)')}</td>
        <td><span class="pill">${escapeHtml(s.barcode||'')}</span></td>
        <td class="right">${s.qty||0}</td>
      `;
      undoBody.appendChild(tr);
    }
  }
  document.getElementById('undoOpen').addEventListener('click', ()=>{ buildUndoTable(); undoModal.style.display='grid'; });
  document.getElementById('undoCancel').addEventListener('click', ()=> undoModal.style.display='none');
  document.getElementById('undoConfirm').addEventListener('click', async ()=>{
    const sel = document.querySelector('input[name="undoPick"]:checked');
    if(!sel){ alert('Pick one item to remove.'); return; }
    const id = sel.value;
    const item = sales.find(s=>s.id===id);
    if(!item){ alert('Item not found.'); return; }

    sales = sales.filter(s=>s.id!==id);
    saveJSON(LS_SALES, sales);
    renderFront(); renderScanLog();
    showToast('Removed selected item', 'ok');
    undoModal.style.display='none';

    const ok = await sendToGAS({ type:"undo", payload:{ id:item.id, barcode:item.barcode, ts:item.ts }});
    if(!ok){ const q=loadQueue(); q.push({ type:"undo", payload:{ id:item.id, barcode:item.barcode, ts:item.ts }}); saveQueue(q); }
    else { 
      await flushQueue(); 
      await pullTodayFromServer(true);   // authoritative refresh
    }
  });

  /******** Init + time ********/
  function tickCST(){ cstClock.textContent = fmtTimeCST(new Date()); }
  async function init(){
    refreshBadges();
    ensureLocalDayOnSales();

    await flushQueue();                           // 1) push pending writes
    const ok = await pullTodayFromServer(true);   // 2) pull canonical snapshot

    if (!ok && (!inventory.length || !sales.length)) {
      inventory = SEED_FALLBACK.slice();          // 3) only if nothing to show
      saveJSON(LS_INV, inventory);
    }

    renderFront(); renderScanLog(); if (adminView.style.display !== 'none') renderAdmin(); // 4) show UI

    tickCST(); setInterval(tickCST, 1000);
    setInterval(() => pullTodayFromServer(false), 60000); // background 60s sync
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') pullTodayFromServer(false);
    });
  }
  init();

  /******** 7:00 AM CST behavior: pull fresh snapshot (server clears) ********/
  function resetTodayLocal(){ /* retained for manual Clear button */ }
  async function checkSevenClear(){
    const { hour, minute } = nowCSTParts();
    const todayCST = todayKeyCST();
    const already = localStorage.getItem(LS_CLEARED_ON);
    if (hour === '07' && minute === '00' && already !== todayCST) {
      await pullTodayFromServer(true);
      localStorage.setItem(LS_CLEARED_ON, todayCST);
      showToast('Daily refresh from server (7:00 AM CST)', 'ok', 1800);
    }
  }
  setInterval(checkSevenClear, 15000);
</script>
</body>
</html>
