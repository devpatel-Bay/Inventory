const TZ = 'America/Chicago';
const SHEET_SALES = 'Sales';
const SHEET_CATALOG = 'Catalog';
const RECIPIENT = 'dev.patel@baywoodhotels.com';

// ===== HTTP ENTRY =====
function doPost(e) {
  try {
    const body = JSON.parse(e.postData.contents || '{}');
    if (body.type === 'sale') return handleSale(body.payload);
    if (body.type === 'catalog') return handleCatalogUpsert(body.payload);
    return json({ ok:false, error:'Unknown type' });
  } catch (err) {
    return json({ ok:false, error:String(err) });
  }
}

function handleSale(ev) {
  // ev: { ts, hotel, barcode, name, priceSold, qty, revenue }
  const ss = SpreadsheetApp.getActive();
  const sh = ss.getSheetByName(SHEET_SALES) || ss.insertSheet(SHEET_SALES);
  if (sh.getLastRow() === 0) {
    sh.appendRow(['ts','localDate','hotel','barcode','name','priceSold','qty','revenue']);
  }
  const ts = ev.ts || new Date().toISOString();
  const local = Utilities.formatDate(new Date(ts), TZ, 'yyyy-MM-dd');
  sh.appendRow([
    ts, local,
    ev.hotel || '',
    ev.barcode || '',
    ev.name || '',
    Number(ev.priceSold) || 0,
    Number(ev.qty) || 0,
    Number(ev.revenue) || 0
  ]);
  return json({ ok:true });
}

// Optional: push your catalog from the Admin page (list of products)
function handleCatalogUpsert(list) {
  if (!Array.isArray(list)) return json({ ok:false, error:'Payload must be array' });
  const ss = SpreadsheetApp.getActive();
  const sh = ss.getSheetByName(SHEET_CATALOG) || ss.insertSheet(SHEET_CATALOG);
  if (sh.getLastRow() === 0) {
    sh.appendRow(['barcode','name','priceSold','vendorCost','startingInventory','lastUpdated']);
  }
  const now = new Date();
  const existing = sh.getDataRange().getValues();
  const index = new Map();
  for (let i=1;i<existing.length;i++) {
    const bc = String(existing[i][0]||'');
    if (bc) index.set(bc, i+1);
  }
  list.forEach(p => {
    const bc = String(p.barcode||'').trim();
    if (!bc) return;
    const row = index.get(bc);
    const values = [bc, p.name||'', Number(p.priceSold)||0, Number(p.vendorCost)||0, Number(p.startingInventory)||0, now];
    if (row) sh.getRange(row,1,1,6).setValues([values]);
    else sh.appendRow(values);
  });
  return json({ ok:true, updated:list.length });
}

function json(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

// ===== DAILY EMAIL @ 7AM + ROLL-FORWARD =====
function emailYesterdayAndRoll() {
  const ss = SpreadsheetApp.getActive();
  const sales = ss.getSheetByName(SHEET_SALES);
  const catalog = ss.getSheetByName(SHEET_CATALOG);
  if (!sales || !catalog) return;

  const y = new Date(new Date().getTime() - 24*60*60*1000);
  const yKey = Utilities.formatDate(y, TZ, 'yyyy-MM-dd');

  const salesRows = sales.getDataRange().getValues();
  const catRows = catalog.getDataRange().getValues();
  if (salesRows.length <= 1 || catRows.length <= 1) return;

  // Build catalog map
  const catMap = new Map(); // bc -> {row, name, priceSold, vendorCost, starting}
  for (let i=1;i<catRows.length;i++) {
    const [bc,name,priceSold,vendorCost,startingInventory] = catRows[i];
    if (!bc) continue;
    catMap.set(String(bc), {
      row: i+1,
      name: String(name||''),
      priceSold: Number(priceSold)||0,
      vendorCost: Number(vendorCost)||0,
      starting: Number(startingInventory)||0
    });
  }

  // Aggregate yesterday sales
  const byBc = new Map(); // bc -> { name, qty, revenue }
  let totalQty = 0, totalRev = 0;
  for (let i=1;i<salesRows.length;i++) {
    const [ts, localDate,, bc, name, priceSold, qty, revenue] = salesRows[i];
    if (String(localDate) !== yKey) continue;
    const key = String(bc||'');
    const rec = byBc.get(key) || { name:String(name||''), qty:0, revenue:0 };
    rec.qty += Number(qty)||0;
    rec.revenue += Number(revenue)||0;
    byBc.set(key, rec);
    totalQty += Number(qty)||0;
    totalRev += Number(revenue)||0;
  }

  // Compute ending inventory yesterday and roll forward starting
  const updates = [];
  const tableRows = [];
  [...byBc.entries()].forEach(([bc, rec]) => {
    const cat = catMap.get(bc) || { name: rec.name, starting: 0, vendorCost:0, priceSold:0, row:null };
    const start = Number(cat.starting)||0;
    const end = Math.max(0, start - rec.qty);
    tableRows.push({ name: cat.name || rec.name || '', barcode: bc, start, units: rec.qty, end, revenue: rec.revenue });
    if (cat.row) updates.push({ row: cat.row, end });
  });

  tableRows.sort((a,b)=> b.units - a.units);

  const title = `What sold on ${yKey} â€” and inventory left`;
  let html = `<div style="font-family:system-ui,Segoe UI,Arial">
    <h2>${title}</h2>
    <table cellspacing="0" cellpadding="6" border="1" style="border-collapse:collapse">
      <tr>
        <th align="left">Product</th>
        <th align="left">Barcode</th>
        <th align="right">Starting</th>
        <th align="right">Units Sold</th>
        <th align="right">Ending</th>
        <th align="right">Revenue</th>
      </tr>`;
  tableRows.forEach(r => {
    html += `<tr>
      <td>${esc(r.name)}</td>
      <td>${esc(r.barcode)}</td>
      <td align="right">${r.start}</td>
      <td align="right">${r.units}</td>
      <td align="right"><b>${r.end}</b></td>
      <td align="right">$${Number(r.revenue||0).toFixed(2)}</td>
    </tr>`;
  });
  const totalQty = tableRows.reduce((a,r)=>a+r.units,0);
  const totalRev = tableRows.reduce((a,r)=>a+(r.revenue||0),0);
  html += `<tr><td colspan="3" align="right"><b>Total</b></td><td align="right"><b>${totalQty}</b></td><td></td><td align="right"><b>$${totalRev.toFixed(2)}</b></td></tr>`;
  html += `</table></div>`;

  if (tableRows.length > 0) {
    MailApp.sendEmail({ to: RECIPIENT, subject: title, htmlBody: html });
  }

  // Roll forward: set Catalog.startingInventory = yesterday ending
  if (updates.length) {
    updates.forEach(u => { catalog.getRange(u.row, 5).setValue(u.end); }); // col 5 = startingInventory
    catalog.getRange(2, 6, catalog.getLastRow()-1, 1).setValue(new Date()); // col 6 = lastUpdated
  }
}

function esc(s){ return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

// ===== TRIGGER SETUP =====
function setupDaily7am() {
  ScriptApp.getProjectTriggers().forEach(t => {
    if (t.getHandlerFunction() === 'emailYesterdayAndRoll') ScriptApp.deleteTrigger(t);
  });
  ScriptApp.newTrigger('emailYesterdayAndRoll')
    .timeBased().atHour(7).nearMinute(0).inTimezone(TZ).everyDays(1).create();
}
