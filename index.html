<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Hotel Inventory & Sales Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root { --bg:#f6f6f7; --card:#fff; --border:#e5e7eb; --text:#111; --muted:#6b7280; --ok:#16a34a; --err:#dc2626; --warn:#f59e0b;}
  * { box-sizing: border-box; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); color:var(--text); }
  .container { max-width: 1100px; margin: 0 auto; padding: 16px; }
  header { display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
  h1 { font-size: 22px; font-weight: 700; margin:0; }
  .btn { border:1px solid var(--border); background:#fff; padding:8px 12px; border-radius:14px; font-size:14px; cursor:pointer; }
  .btn.primary { background:#111; color:#fff; }
  .btn:active { transform: scale(.98); }
  .card { background:var(--card); border:1px solid var(--border); border-radius:18px; padding:16px; box-shadow: 0 1px 2px rgba(0,0,0,.03); margin-top:16px; }
  .card-title { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }
  .input { width:100%; border:1px solid var(--border); border-radius:12px; padding:10px; font-size:14px; }
  .input[readonly] { background:#fafafa; cursor:pointer; }
  .input[type="number"] { text-align:right; }
  table { width:100%; border-collapse:collapse; font-size:14px; }
  thead tr { background:#f3f4f6; }
  th, td { text-align:left; padding:8px; border-bottom:1px solid var(--border); vertical-align: middle; }
  th.right, td.right { text-align:right; }
  .small { font-size:12px; color:var(--muted); }
  .pill { display:inline-flex; border:1px solid var(--border); border-radius:999px; padding:2px 8px; font-size:12px; color:#374151; }
  .row { display:flex; gap:12px; }
  .grow { flex:1 1 auto; }
  .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; place-items:center; padding:16px; z-index:1000; }
  .modal { background:#fff; border:1px solid var(--border); border-radius:16px; width:100%; max-width:560px; padding:16px; box-shadow: 0 6px 24px rgba(0,0,0,.12); }
  .toast { position:fixed; top:12px; right:12px; z-index:2000; padding:10px 14px; border-radius:12px; color:#fff; font-weight:600; display:none; }
  .toast.ok { background:var(--ok); }
  .toast.err { background:var(--err); }
  .toast.warn { background:var(--warn); color:#111; }
  #scanStrip { display:flex; gap:6px; flex-wrap:wrap; margin-top:8px; }
  .chip { border:1px solid var(--border); background:#fff; border-radius:999px; padding:4px 8px; font-size:12px; }
  .chip.ok { border-color:#bbf7d0; background:#f0fdf4; }
  .chip.err { border-color:#fecaca; background:#fef2f2; }
  .banner { background:#fff7ed; border:1px solid #fed7aa; color:#7c2d12; padding:8px 12px; border-radius:12px; margin-top:8px; display:none; }
  .pill-kbd { font-family:ui-monospace, SFMono-Regular, Menlo, monospace; border:1px solid var(--border); padding:1px 6px; border-radius:6px; background:#fff; }
</style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Hotel Inventory & Sales Tracker</h1>
      <div>
        <button id="frontBtn" class="btn primary">Front Desk (Scan)</button>
        <button id="adminBtn" class="btn">Admin</button>
      </div>
    </header>

    <div class="row" style="align-items:center; justify-content:space-between; margin-top:8px;">
      <div class="small">Hotel: <b id="hotelBadge">Your Hotel Name</b> • GAS: <span id="gasBadge">Not set</span></div>
      <button id="setupOpen" class="btn">Setup</button>
    </div>

    <div id="focusBanner" class="banner">Scanner input wasn’t focused. We refocused it for you—please scan again.</div>

    <!-- Front Desk -->
    <section id="frontView" class="card">
      <div class="card-title">
        <h3 style="margin:0; font-size:16px; font-weight:600">Scan Items</h3>
        <div class="small">Tip: press <span class="pill-kbd">U</span> to Undo.</div>
      </div>

      <div class="row">
        <div class="grow">
          <div class="small" style="margin-bottom:6px">Barcode Input (opens scan session)</div>
          <input id="scanInput" class="input" placeholder="Click here to start a Scan Session" readonly />
          <div id="lastScan" class="small" style="margin-top:8px"></div>
        </div>
        <div style="width:320px">
          <div class="small" style="margin-bottom:6px">Quick Search</div>
          <input id="filterInput" class="input" placeholder="Filter by name or barcode" />
        </div>
      </div>

      <div id="scanStrip" aria-live="polite"></div>

      <!-- Today’s Scan Log -->
      <div class="card" style="margin-top:16px;">
        <div class="card-title">
          <h3 style="margin:0; font-size:16px; font-weight:600">Today’s Scan Log</h3>
        </div>
        <div style="overflow:auto">
          <table id="logTable">
            <thead>
              <tr>
                <th>Product</th>
                <th>Barcode</th>
                <th class="right">UNITS SOLD TODAY</th>
                <th class="right">REVENUE TODAY</th>
                <th class="right">LAST SCAN</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Inventory ranked -->
      <div class="card" style="margin-top:16px;">
        <div class="card-title">
          <h3 style="margin:0; font-size:16px; font-weight:600">Inventory (ranked by Units Sold Today)</h3>
          <button id="undoBtn" class="btn">Undo Last Sale (Today)</button>
        </div>
        <div style="overflow:auto">
          <table id="frontTable">
            <thead>
              <tr>
                <th>Product</th>
                <th class="right">PRICE SOLD</th>
                <th class="right">STARTING INVENTORY</th>
                <th class="right">UNITS SOLD TODAY</th>
                <th class="right">ENDING INVENTORY</th>
                <th class="right">PRICE SOLD × UNITS SOLD</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="row" style="gap:16px; margin-top:8px;">
        <div class="card grow">
          <div class="small">Units Sold Today</div>
          <div id="unitsSold" style="font-size:18px; font-weight:600">0</div>
        </div>
        <div class="card grow">
          <div class="small">Revenue (Price × Units)</div>
          <div id="revenueToday" style="font-size:18px; font-weight:600">$0.00</div>
        </div>
      </div>
    </section>

    <!-- Admin -->
    <section id="adminView" class="card" style="display:none">
      <div class="card-title">
        <h3 style="margin:0; font-size:16px; font-weight:600">Admin Controls</h3>
        <div class="row">
          <button id="addProduct" class="btn">Add Product</button>
          <button id="exportCSV" class="btn">Export CSV</button>
          <label class="btn" style="cursor:pointer">Import CSV<input id="importCSV" type="file" accept=".csv" style="display:none" /></label>
          <button id="clearToday" class="btn">Clear Today Sales</button>
          <button id="syncCatalog" class="btn">Sync Catalog → Sheet</button>
          <button id="changePass" class="btn">Change Password</button>
        </div>
      </div>

      <div class="row" style="margin-bottom:8px">
        <input id="adminFilter" class="input grow" placeholder="Filter by name, barcode, or category" />
      </div>

      <div style="overflow:auto">
        <table id="adminTable">
          <thead>
            <tr>
              <th>Product</th>
              <th>Barcode</th>
              <th>Category</th>
              <th class="right">PRICE SOLD</th>
              <th class="right">VENDOR COST</th>
              <th class="right">STARTING INVENTORY</th>
              <th class="right">UNITS SOLD TODAY</th>
              <th class="right">ENDING INVENTORY</th>
              <th class="right">PRICE SOLD × UNITS SOLD</th>
              <th class="right">ENDING INVENTORY (×) VENDOR COST</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- Setup Modal -->
  <div id="setupModal" class="modal-backdrop">
    <div class="modal">
      <h3 style="margin-top:0">Setup</h3>
      <div class="row" style="align-items:center; margin-bottom:8px">
        <label style="width:120px">Hotel name</label>
        <input id="hotelInput" class="input grow" />
      </div>
      <div class="row" style="align-items:center">
        <label style="width:120px">Apps Script URL</label>
        <input id="gasInput" class="input grow" placeholder="https://script.google.com/macros/s/.../exec" />
      </div>
      <div id="setupMsg" class="small" style="margin-top:8px"></div>
      <div class="row" style="justify-content:flex-end; margin-top:12px">
        <button id="saveSetup" class="btn">Save URL</button>
        <button id="testPing" class="btn">Send test ping</button>
        <button id="closeSetup" class="btn primary">Close</button>
      </div>
    </div>
  </div>

  <!-- Admin Password Modal -->
  <div id="passModal" class="modal-backdrop">
    <div class="modal">
      <h3 style="margin-top:0">Enter Admin Password</h3>
      <input id="passField" class="input" type="password" placeholder="Password (default: admin123)" />
      <div id="passErr" style="color:#dc2626; margin-top:6px; font-size:14px"></div>
      <div class="row" style="justify-content:flex-end; margin-top:12px">
        <button id="passCancel" class="btn">Cancel</button>
        <button id="passOk" class="btn primary">Unlock</button>
      </div>
    </div>
  </div>

  <!-- Scan Session Modal -->
  <div id="sessionModal" class="modal-backdrop">
    <div class="modal">
      <h3 style="margin-top:0">Scan Session</h3>
      <div class="small" style="margin-bottom:6px">Scan items now. Press Enter at the end of each barcode. Debounce prevents double reads.</div>
      <div id="sessionHint" class="small" style="margin-bottom:8px">Waiting for first scan…</div>
      <div style="max-height:260px; overflow:auto; border:1px solid var(--border); border-radius:12px;">
        <table style="width:100%; border-collapse:collapse;">
          <thead><tr><th style="padding:6px 8px;">Product</th><th>Barcode</th><th class="right" style="padding:6px 8px;">Qty</th><th class="right" style="padding:6px 8px;">Revenue</th></tr></thead>
        <tbody id="sessionBody"></tbody>
        </table>
      </div>
      <div class="row" style="justify-content:flex-end; margin-top:12px">
        <button id="sessionCancel" class="btn">Cancel</button>
        <button id="sessionPost" class="btn primary">Post</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
  /******** Storage keys ********/
  const LS_INV="hotel_inventory_v1", LS_SALES="hotel_sales_v1", LS_ADMIN_PASS="hotel_admin_pass_v1";
  const LS_QUEUE="sales_queue_v1", LS_LAST_DAY="last_open_day_v1", LS_HOTEL="hotel_name_v1", LS_GAS="gas_webapp_url_v1";

  /******** Helpers ********/
  const currency = n => isNaN(n) ? "-" : Number(n).toLocaleString(undefined,{style:"currency",currency:"USD"});
  const localDateKey = d => { const dt = (d instanceof Date)? d : new Date(d); return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,"0")}-${String(dt.getDate()).padStart(2,"0")}`; };
  const todayKey = () => localDateKey(new Date());
  const loadJSON = (k,f)=>{ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):f; }catch{ return f; }};
  const saveJSON = (k,v)=>localStorage.setItem(k,JSON.stringify(v));
  const escapeHtml = s => String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  function fmtTime(ts){ try{ const d=new Date(ts); return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }catch{ return '-'; } }

  /******** App state ********/
  let inventory = loadJSON(LS_INV, [
    { id: crypto.randomUUID(), barcode:"0123456789012", name:"Bottled Water 16oz", priceSold:1.99, vendorCost:0.45, startingInventory:50, category:"Drinks" },
    { id: crypto.randomUUID(), barcode:"1234567890123", name:"Chips - Classic",    priceSold:2.49, vendorCost:0.65, startingInventory:40, category:"Snacks" },
    { id: crypto.randomUUID(), barcode:"2345678901234", name:"Chocolate Bar",      priceSold:2.99, vendorCost:0.85, startingInventory:35, category:"Snacks" }
  ]);
  let sales = loadJSON(LS_SALES, []);
  let adminPass = localStorage.getItem(LS_ADMIN_PASS) || "admin123";

  // New day: clear local "today" list (only today's cached view)
  (function(){ const t=todayKey(); const last=localStorage.getItem(LS_LAST_DAY); if(last && last!==t){ sales=[]; saveJSON(LS_SALES,sales); } localStorage.setItem(LS_LAST_DAY,t); })();

  /******** DOM refs ********/
  const frontBtn = document.getElementById('frontBtn');
  const adminBtn = document.getElementById('adminBtn');
  const frontView = document.getElementById('frontView');
  const adminView = document.getElementById('adminView');

  const scanInput = document.getElementById('scanInput');
  const filterInput = document.getElementById('filterInput');
  const lastScan = document.getElementById('lastScan');
  const frontTbody = document.querySelector('#frontTable tbody');
  const logTbody = document.querySelector('#logTable tbody');
  const unitsSoldEl = document.getElementById('unitsSold');
  const revenueTodayEl = document.getElementById('revenueToday');
  const focusBanner = document.getElementById('focusBanner');
  const scanStrip = document.getElementById('scanStrip');

  const adminFilter = document.getElementById('adminFilter');
  const adminTbody = document.querySelector('#adminTable tbody');

  const hotelBadge = document.getElementById('hotelBadge');
  const gasBadge = document.getElementById('gasBadge');

  const setupOpen = document.getElementById('setupOpen');
  const setupModal = document.getElementById('setupModal');
  const hotelInput = document.getElementById('hotelInput');
  const gasInput = document.getElementById('gasInput');
  const setupMsg = document.getElementById('setupMsg');
  const saveSetup = document.getElementById('saveSetup');
  const testPing = document.getElementById('testPing');
  const closeSetup = document.getElementById('closeSetup');

  const passModal = document.getElementById('passModal');
  const passField = document.getElementById('passField');
  const passErr = document.getElementById('passErr');
  const passCancel = document.getElementById('passCancel');
  const passOk = document.getElementById('passOk');

  const undoBtn = document.getElementById('undoBtn');
  const addProduct = document.getElementById('addProduct');
  const exportCSV = document.getElementById('exportCSV');
  const importCSV = document.getElementById('importCSV');
  const clearToday = document.getElementById('clearToday');
  const syncCatalog = document.getElementById('syncCatalog');

  // Scan Session modal
  const sessionModal = document.getElementById('sessionModal');
  const sessionBody  = document.getElementById('sessionBody');
  const sessionHint  = document.getElementById('sessionHint');
  const sessionCancel= document.getElementById('sessionCancel');
  const sessionPost  = document.getElementById('sessionPost');

  /******** Setup helpers ********/
  const getHotelName = ()=> localStorage.getItem(LS_HOTEL) || "Your Hotel Name";
  const setHotelName = n => localStorage.setItem(LS_HOTEL, n);
  const getGAS = ()=> localStorage.getItem(LS_GAS) || "";
  const setGAS = u => localStorage.setItem(LS_GAS, u);
  function refreshBadges(){ hotelBadge.textContent = getHotelName(); gasBadge.textContent = getGAS() ? "Saved" : "Not set"; }

  /******** Networking (send-first, queue-on-fail) ********/
  const loadQueue = ()=>loadJSON(LS_QUEUE,[]);
  const saveQueue = q=>saveJSON(LS_QUEUE,q);
  async function sendToGAS(evt){
    const url = getGAS(); if(!url) return true;
    try{ await fetch(url, { method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify(evt), mode:"no-cors" }); return true; }
    catch(e){ return false; }
  }
  async function postBatch(entries){
    const url = getGAS(); if(!url) return true;
    try{
      await fetch(url, { method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify({ type:"batch", payload: entries }), mode:"no-cors" });
      return true;
    }catch(e){ return false; }
  }
  async function flushQueue(){
    const url=getGAS(); if(!url) return;
    const q=loadQueue(); if(!q.length) return;
    const still=[];
    for(const evt of q){
      const ok = evt?.type==="batch" ? await postBatch(evt.payload) : await sendToGAS(evt);
      if(!ok) still.push(evt);
    }
    saveQueue(still);
  }
  window.addEventListener('online', flushQueue);

  /******** Local-day stamping on old rows ********/
  function ensureLocalDayOnSales(){ let changed=false; sales.forEach(s=>{ if(!s.ld){ s.ld=localDateKey(s.ts); changed=true; } }); if(changed) saveJSON(LS_SALES,sales); }

  /******** Aggregations ********/
  function todaysAggregate(){
    const day = todayKey();
    const byItem = new Map();
    for(const s of sales){
      const isToday = s.ld ? (s.ld===day) : (localDateKey(s.ts)===day);
      if(!isToday) continue;
      const bc = s.barcode;
      const prod = inventory.find(p=>p.barcode===bc);
      const name = prod?.name || '(Unknown)';
      const price = prod?.priceSold || 0;
      const rec = byItem.get(bc) || { name, price, sold:0, revenue:0, lastTs:null, barcode: bc };
      rec.sold += (s.qty||0);
      rec.revenue += (price*(s.qty||0));
      if(!rec.lastTs || new Date(s.ts) > new Date(rec.lastTs)) rec.lastTs = s.ts;
      byItem.set(bc, rec);
    }
    return Array.from(byItem.values());
  }
  function todaySalesMap(){ const m=new Map(); todaysAggregate().forEach(r=> m.set(r.barcode, r.sold)); return m; }

  /******** Toast + sounds ********/
  const toastEl = document.getElementById('toast');
  function showToast(msg, kind='ok', ms=1200){ toastEl.textContent = msg; toastEl.className = `toast ${kind}`; toastEl.style.display = 'block'; setTimeout(()=> toastEl.style.display='none', ms); }
  function beepOk(){ tone(880, 80); }
  function beepErr(){ tone(220, 160); }
  function tone(freq, dur){ try{ const ctx = new (window.AudioContext||window.webkitAudioContext)(); const o = ctx.createOscillator(); const g = ctx.createGain(); o.type='sine'; o.frequency.value=freq; o.connect(g); g.connect(ctx.destination); g.gain.setValueAtTime(0.001, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.1, ctx.currentTime+0.01); o.start(); setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.02); o.stop(ctx.currentTime+0.03); ctx.close(); }, dur);}catch{} }

  /******** Renderers ********/
  function renderScanLog(){
    const rows = todaysAggregate().sort((a,b)=> b.sold - a.sold || (new Date(b.lastTs)-new Date(a.lastTs)));
    logTbody.innerHTML="";
    if(!rows.length){ const tr=document.createElement('tr'); tr.innerHTML = `<td colspan="5" class="small">No scans yet today.</td>`; logTbody.appendChild(tr); return; }
    for(const r of rows){
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(r.name)}</td>
        <td><span class="pill">${escapeHtml(r.barcode||'')}</span></td>
        <td class="right">${r.sold}</td>
        <td class="right">${currency(r.revenue)}</td>
        <td class="right">${r.lastTs? fmtTime(r.lastTs): '-'}</td>
      `;
      logTbody.appendChild(tr);
    }
  }
  function renderFront(){
    const query = (filterInput.value||"").trim().toLowerCase();
    const map = todaySalesMap();
    const items = inventory.map(p=>{
      const sold = map.get(p.barcode)||0;
      const end = Math.max(0,(p.startingInventory||0)-sold);
      const rev = (p.priceSold||0)*sold;
      return { p, sold, end, rev };
    }).filter(row=>{
      if(!query) return true;
      return row.p.name.toLowerCase().includes(query) || (row.p.barcode||"").toLowerCase().includes(query);
    }).sort((a,b)=> b.sold - a.sold);

    frontTbody.innerHTML = "";
    let totalUnits=0, totalRev=0;
    for(const row of items){
      const {p, sold, end, rev} = row;
      totalUnits += sold; totalRev += rev;
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td><div style="display:flex;align-items:center;gap:8px"><div style="font-weight:600">${escapeHtml(p.name)}</div><span class="pill">${escapeHtml(p.barcode||"no barcode")}</span></div></td>
        <td class="right">${currency(p.priceSold)}</td>
        <td class="right">${p.startingInventory||0}</td>
        <td class="right">${sold}</td>
        <td class="right">${end}</td>
        <td class="right">${currency(rev)}</td>
      `;
      frontTbody.appendChild(tr);
    }
    unitsSoldEl.textContent = String(totalUnits);
    revenueTodayEl.textContent = currency(totalRev);
  }
  function renderAdmin(){
    const q=(adminFilter.value||"").trim().toLowerCase();
    const map = todaySalesMap();
    adminTbody.innerHTML = "";
    for(const p of inventory){
      if(q && !(p.name.toLowerCase().includes(q) || (p.barcode||"").toLowerCase().includes(q) || (p.category||"").toLowerCase().includes(q))) continue;
      const sold = map.get(p.barcode)||0;
      const end = Math.max(0,(p.startingInventory||0)-sold);
      const rev = (p.priceSold||0)*sold;
      const endCost = (p.vendorCost||0)*end;
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td><input class="input" value="${escapeHtml(p.name)}" data-f="name" /></td>
        <td><input class="input" value="${escapeHtml(p.barcode||"")}" data-f="barcode" /></td>
        <td><input class="input" value="${escapeHtml(p.category||"")}" data-f="category" /></td>
        <td class="right"><input class="input" type="number" step="0.01" value="${Number(p.priceSold)||0}" data-f="priceSold" /></td>
        <td class="right"><input class="input" type="number" step="0.01" value="${Number(p.vendorCost)||0}" data-f="vendorCost" /></td>
        <td class="right"><input class="input" type="number" value="${Number(p.startingInventory)||0}" data-f="startingInventory" /></td>
        <td class="right">${sold}</td>
        <td class="right">${end}</td>
        <td class="right">${currency(rev)}</td>
        <td class="right">${currency(endCost)}</td>
        <td class="right"><button class="btn" data-act="del">Delete</button></td>
      `;
      tr.querySelectorAll('input').forEach(inp=>{
        inp.addEventListener('change', ()=>{
          const f=inp.getAttribute('data-f');
          let val=inp.value;
          if(f==='priceSold'||f==='vendorCost') val=parseFloat(val)||0;
          if(f==='startingInventory') val=parseInt(val)||0;
          p[f]=val; saveJSON(LS_INV, inventory); renderFront(); renderScanLog(); renderAdmin();
        });
      });
      tr.querySelector('[data-act="del"]').addEventListener('click', ()=>{
        if(!confirm('Remove this product?')) return;
        inventory=inventory.filter(x=>x.id!==p.id);
        saveJSON(LS_INV, inventory); renderFront(); renderScanLog(); renderAdmin();
      });
      adminTbody.appendChild(tr);
    }
  }

  /******** Filters ********/
  filterInput.addEventListener('input', ()=>{ renderFront(); renderScanLog(); });
  adminFilter.addEventListener('input', renderAdmin);

  /******** Catalog mgmt ********/
  addProduct.addEventListener('click', ()=>{
    inventory.push({ id:crypto.randomUUID(), barcode:"", name:"New Product", priceSold:0, vendorCost:0, startingInventory:0, category:"" });
    saveJSON(LS_INV, inventory); renderFront(); renderScanLog(); renderAdmin();
  });
  exportCSV.addEventListener('click', ()=>{
    const headers=["barcode","name","priceSold","vendorCost","startingInventory","category"];
    const body=inventory.map(p=>[p.barcode,p.name,p.priceSold,p.vendorCost,p.startingInventory,p.category||""].map(x=>String(x).replaceAll(",","")).join(",")).join("\n");
    const csv=headers.join(",")+"\n"+body;
    const blob=new Blob([csv],{type:"text/csv"}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=`inventory_${todayKey()}.csv`; a.click(); URL.revokeObjectURL(url);
  });
  importCSV.addEventListener('change', (ev)=>{
    const f=ev.target.files?.[0]; if(!f) return;
    const r=new FileReader(); r.onload=()=>{
      const text=String(r.result||""); const rows=text.split(/\r?\n/).filter(Boolean); if(!rows.length) return;
      const headers=rows[0].split(",").map(h=>h.trim()); const idx=k=>headers.indexOf(k);
      const out=[];
      for(let i=1;i<rows.length;i++){
        const cols=rows[i].split(",");
        out.push({ id: crypto.randomUUID(), barcode: cols[idx("barcode")]?.trim() || "", name: cols[idx("name")]?.trim() || "",
          priceSold: parseFloat(cols[idx("priceSold")]) || 0, vendorCost: parseFloat(cols[idx("vendorCost")]) || 0,
          startingInventory: parseInt(cols[idx("startingInventory")]) || 0, category: cols[idx("category")]?.trim() || "" });
      }
      if(out.length){ inventory=out; saveJSON(LS_INV, inventory); renderFront(); renderScanLog(); renderAdmin(); }
      ev.target.value="";
    };
    r.readAsText(f);
  });
  clearToday.addEventListener('click', ()=>{
    if(!confirm("Clear today’s sales (today only)?")) return;
    const day=todayKey(); sales=sales.filter(s=> (s.ld ? s.ld !== day : localDateKey(s.ts)!==day) ); saveJSON(LS_SALES,sales);
    renderFront(); renderScanLog(); renderAdmin();
  });
  syncCatalog.addEventListener('click', async ()=>{
    const url=getGAS(); if(!url){ alert("Add Apps Script URL in Setup first."); return; }
    const payload=inventory.map(p=>({ barcode:p.barcode||"", name:p.name||"", priceSold:p.priceSold||0, vendorCost:p.vendorCost||0, startingInventory:p.startingInventory||0 }));
    await fetch(url,{ method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify({type:"catalog", payload}), mode:"no-cors" });
    alert("Catalog sync sent. Check the 'Catalog' tab.");
  });

  /******** Tabs + admin auth ********/
  frontBtn.addEventListener('click', ()=>{ frontBtn.classList.add('primary'); adminBtn.classList.remove('primary'); frontView.style.display="block"; adminView.style.display="none"; });
  adminBtn.addEventListener('click', ()=>{ passErr.textContent=""; passField.value=""; passModal.style.display="grid"; });
  passCancel.addEventListener('click', ()=> passModal.style.display="none");
  passOk.addEventListener('click', ()=>{
    if(passField.value===adminPass){
      passModal.style.display="none";
      frontBtn.classList.remove('primary'); adminBtn.classList.add('primary');
      frontView.style.display="none"; adminView.style.display="block";
      renderAdmin();
    } else { passErr.textContent="Incorrect password"; }
  });
  document.getElementById('changePass').addEventListener('click', ()=>{
    const cur=prompt("Current password:"); if(cur!==adminPass) return alert("Incorrect.");
    const next=prompt("New password:"); if(!next) return;
    adminPass=next; localStorage.setItem(LS_ADMIN_PASS, adminPass); alert("Password updated.");
  });

  /******** Setup modal ********/
  setupOpen.addEventListener('click', ()=>{
    hotelInput.value=getHotelName(); gasInput.value=getGAS(); setupMsg.textContent=""; setupModal.style.display="grid";
  });
  closeSetup.addEventListener('click', ()=>setupModal.style.display="none");
  saveSetup.addEventListener('click', ()=>{ setHotelName(hotelInput.value.trim()||"Your Hotel Name"); setGAS(gasInput.value.trim()); refreshBadges(); setupMsg.textContent="Saved!"; });
  testPing.addEventListener('click', async ()=>{
    const url=getGAS(); if(!url){ setupMsg.textContent="Paste your Web App URL first."; return; }
    setupMsg.textContent="Sending test ping…";
    const ok = await sendToGAS({ type:"sale", payload:{ id: crypto.randomUUID(), ts:new Date().toISOString(), hotel:getHotelName(), barcode:"TEST", name:"Ping", priceSold:0, qty:0, revenue:0 }});
    setupMsg.textContent = ok ? "Ping sent (check Sales tab)" : "Ping failed (check deployment/permissions).";
  });

  /************ DOUBLE-ENTRY GUARD ************/
  const SCAN_DEBOUNCE_MS = 250;
  const recentScanTimes = new Map(); // barcode -> lastTimeMs
  function shouldAcceptScan(code){
    const now = Date.now();
    const last = recentScanTimes.get(code) || 0;
    if (now - last < SCAN_DEBOUNCE_MS) return false;
    recentScanTimes.set(code, now);
    return true;
  }

  /******** Global scanner capture ********/
  let buffer = '';
  let bufTimer = null;
  const INTERVAL = 50; // ms gap

  document.addEventListener('keydown', (e)=>{
    const inSession = sessionModal.style.display === 'grid';
    const t = e.target; const tag = (t && t.tagName || '').toLowerCase();
    const isEditable = (tag==='input' || tag==='textarea' || t?.isContentEditable);

    if(isEditable && !inSession) return;

    if(e.key==='Enter' || e.key==='NumpadEnter'){
      const code = buffer.trim(); buffer = '';
      if(code){
        if(inSession) sessionScan(code);
        else liveScan(code);
      }
      e.preventDefault();
      return;
    }
    if(e.key.length===1){
      buffer += e.key;
      clearTimeout(bufTimer);
      bufTimer = setTimeout(()=>{ buffer=''; }, INTERVAL);
    }

    if(!inSession && (e.key==='u' || e.key==='U')) { e.preventDefault(); undoLast(); }
  });

  function nudgeFocusBanner(){
    focusBanner.style.display = 'block';
    setTimeout(()=> focusBanner.style.display='none', 1500);
  }

  /******** Live scanning (immediate post; optional) ********/
  async function liveScan(code){
    const prod=inventory.find(p=>p.barcode===code);
    if(!prod){ lastScan.textContent = `Unknown barcode: ${code}`; addChip(`Unknown ${code}`, 'err'); beepErr(); showToast('Unknown barcode', 'err'); return; }
    if(!shouldAcceptScan(code)) return;

    lastScan.innerHTML = `Last Scan: <b>${escapeHtml(prod.name)}</b> (${escapeHtml(code)}) • ${currency(prod.priceSold)}`;
    await recordSale(prod, 1);
    addChip(`${prod.name} • +1`, 'ok'); beepOk(); showToast('Sale recorded', 'ok');
  }

  /******** Scan Session ********/
  let sessionMap = new Map(); // barcode -> qty
  function openSession(){
    sessionMap = new Map();
    sessionHint.textContent = 'Waiting for first scan…';
    sessionBody.innerHTML = '';
    sessionModal.style.display = 'grid';
  }
  function closeSession(){ sessionModal.style.display = 'none'; }

  function sessionScan(code){
    const prod=inventory.find(p=>p.barcode===code);
    if(!prod){ addChip(`Unknown ${code}`, 'err'); beepErr(); showToast('Unknown barcode', 'err'); return; }
    if(!shouldAcceptScan(code)) return;
    const cur = sessionMap.get(code) || 0;
    sessionMap.set(code, cur+1);
    sessionHint.textContent = 'Scanning…';
    renderSessionTable();
    beepOk();
  }
  function renderSessionTable(){
    sessionBody.innerHTML = '';
    let total=0, rev=0;
    for(const [bc, qty] of sessionMap.entries()){
      const p = inventory.find(x=>x.barcode===bc);
      const r = (p?.priceSold||0)*qty;
      total += qty; rev += r;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td style="padding:6px 8px;">${escapeHtml(p?.name||'(Unknown)')}</td>
        <td><span class="pill">${escapeHtml(bc)}</span></td>
        <td class="right" style="padding:6px 8px;">${qty}</td>
        <td class="right" style="padding:6px 8px;">${currency(r)}</td>`;
      sessionBody.appendChild(tr);
    }
    if(sessionMap.size===0){
      const tr=document.createElement('tr');
      tr.innerHTML = `<td colspan="4" class="small" style="padding:6px 8px;">No items yet.</td>`;
      sessionBody.appendChild(tr);
    }else{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td colspan="2" style="padding:6px 8px; text-align:right;"><b>Totals</b></td>
        <td class="right" style="padding:6px 8px;"><b>${total}</b></td>
        <td class="right" style="padding:6px 8px;"><b>${currency(rev)}</b></td>`;
      sessionBody.appendChild(tr);
    }
  }
  sessionCancel.addEventListener('click', ()=> closeSession());
  sessionPost.addEventListener('click', async ()=>{
    if (sessionMap.size === 0) { closeSession(); return; }

    // Build single batched payload
    const now = new Date(); const ts = now.toISOString(); const hotel = getHotelName();
    const entries = [];
    for (const [bc, qty] of sessionMap.entries()){
      const p = inventory.find(x=>x.barcode===bc); if(!p) continue;
      entries.push({ id: crypto.randomUUID(), ts, hotel, barcode: bc, name: p.name, priceSold: p.priceSold||0, qty, revenue: (p.priceSold||0)*qty });
    }

    // Optimistic UI: local update first
    const ld = localDateKey(now);
    for (const e of entries) sales.push({ id:e.id, barcode:e.barcode, qty:e.qty, ts:e.ts, ld });
    saveJSON(LS_SALES, sales);
    renderFront(); renderScanLog(); renderAdmin?.();
    closeSession(); showToast('Session posted', 'ok');

    // Network (one call)
    const ok = await postBatch(entries);
    if(!ok){ const q=loadQueue(); q.push({type:"batch", payload:entries}); saveQueue(q); } else { flushQueue(); }
  });

  // Open session on input click
  scanInput.addEventListener('click', ()=>{ openSession(); nudgeFocusBanner(); });

  function addChip(txt, kind='ok'){
    const span=document.createElement('span'); span.className = `chip ${kind==='err'?'err':'ok'}`; span.textContent = txt; scanStrip.prepend(span);
    const max=12; while(scanStrip.children.length>max){ scanStrip.removeChild(scanStrip.lastChild); }
  }

  /******** Undo ********/
  async function undoLast(){
    const day = todayKey();
    const idx = [...sales].map((s,i)=>({s,i})).filter(({s}) => (s.ld ? s.ld === day : localDateKey(s.ts) === day)).map(({i}) => i).pop();
    if(idx===undefined){ showToast('Nothing to undo', 'warn'); return; }
    const removed = sales[idx]; const copy = [...sales]; copy.splice(idx, 1); sales = copy; saveJSON(LS_SALES, sales);
    renderFront(); renderScanLog(); renderAdmin(); addChip(`UNDO ${removed.barcode}`, 'ok'); beepOk(); showToast('Last sale undone', 'ok');
    const evt = { type:"undo", payload:{ id: removed.id || "", barcode: removed.barcode || "", ts: removed.ts || "" } };
    const ok = await sendToGAS(evt); if (!ok) { const q=loadQueue(); q.push(evt); saveQueue(q); } else { flushQueue(); }
  }

  /******** Record sale for live scans ********/
  async function recordSale(prod, qty){
    const now = new Date(); const ts = now.toISOString(); const id = crypto.randomUUID(); const ld = localDateKey(now);
    sales.push({ id, barcode: prod.barcode, qty, ts, ld }); saveJSON(LS_SALES, sales);
    renderFront(); renderScanLog();

    const evt={ type:"sale", payload:{ id, ts, hotel:getHotelName(), barcode:prod.barcode, name:prod.name, priceSold: prod.priceSold, qty, revenue: (prod.priceSold||0)*qty }};
    const ok=await sendToGAS(evt); if(!ok){ const q=loadQueue(); q.push(evt); saveQueue(q); } else { flushQueue(); }
  }

  /******** Init ********/
  function init(){ refreshBadges(); ensureLocalDayOnSales(); renderFront(); renderScanLog(); flushQueue(); }
  init();
</script>
</body>
</html>
