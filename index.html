<!DOCTYPE html>
<html lang="en">
>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Hotel Inventory Tracker</title>
<style>
body{font-family:Arial,Helvetica,sans-serif;background:#fff;color:#111;margin:0}
.container{max-width:1100px;margin:auto;padding:20px}
header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
h1{font-size:20px;margin:0}
.btn{background:#007bff;color:#fff;border:none;padding:8px 14px;border-radius:6px;cursor:pointer}
.btn:active{transform:scale(.98)}
.card{background:#fafafa;border:1px solid #ccc;border-radius:10px;padding:14px;margin-top:15px}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{border-bottom:1px solid #eee;padding:8px;text-align:left}
th.right,td.right{text-align:right}
.small{font-size:12px;color:#555}
.input{padding:6px 8px;border:1px solid #ccc;border-radius:6px;width:100%;font-size:14px}
canvas{width:100%;max-width:800px;height:250px;margin-top:10px}
.toast{position:fixed;top:12px;right:12px;padding:10px 14px;border-radius:10px;background:#007bff;color:#fff;display:none}
</style>
</head>
<body>
<div class="container">
<header>
  <h1>Hotel Inventory & Sales Tracker</h1>
  <div>
    <button id="frontBtn" class="btn">Front Desk</button>
    <button id="adminBtn" class="btn">Admin</button>
  </div>
</header>
<div class="small">CST Time: <b id="cstClock">--</b></div>

<!-- FRONT -->
<section id="frontView" class="card">
  <h3>Scan Items</h3>
  <input id="scanInput" class="input" placeholder="Click here to start scanning" readonly>
  <div id="lastScan" class="small" style="margin-top:5px"></div>
  <table id="frontTable">
    <thead><tr>
      <th>Product</th><th class="right">Price</th><th class="right">Start</th>
      <th class="right">Sold</th><th class="right">End</th><th class="right">Revenue</th>
    </tr></thead>
    <tbody></tbody>
  </table>
</section>

<!-- ADMIN -->
<section id="adminView" class="card" style="display:none">
  <h3>Admin Panel</h3>
  <button id="exportCSV" class="btn">Export CSV</button>
  <button id="testEmail" class="btn" style="background:#28a745">Send Test Email</button>
  <div id="revenueCard" class="card">
    <h4>Daily Revenue Trend</h4>
    <canvas id="revChart"></canvas>
  </div>
  <table id="adminTable">
    <thead><tr>
      <th>Name</th><th>Barcode</th><th class="right">Price</th><th class="right">Cost</th><th class="right">Start Inv.</th>
    </tr></thead>
    <tbody></tbody>
  </table>
</section>
</div>

<div id="toast" class="toast"></div>
<script>
/*** helpers ***/
const LS_INV="hotel_inventory_v3",LS_SALES="hotel_sales_v3",LS_HOTEL="hotel_name_v3",LS_GAS="gas_webapp_v3";
const currency=n=>"$"+(Number(n||0).toFixed(2));
const loadJSON=(k,f)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):f}catch{return f}};
const saveJSON=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const escapeHtml=s=>String(s).replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c]));
const nowCST=()=>new Date(new Date().toLocaleString("en-US",{timeZone:"America/Chicago"}));
function shiftKeyCST(d){const z=d||nowCST();const hr=z.getHours();if(hr<7)z.setDate(z.getDate()-1);return z.toISOString().slice(0,10)}

/*** init data ***/
let inventory=loadJSON(LS_INV,[
 {id:crypto.randomUUID(),barcode:"123",name:"Water",priceSold:1.99,vendorCost:0.5,startingInventory:50},
 {id:crypto.randomUUID(),barcode:"456",name:"Chips",priceSold:2.49,vendorCost:0.6,startingInventory:40}
]);
let sales=loadJSON(LS_SALES,[]);

/*** DOM refs ***/
const frontView=document.getElementById("frontView"),adminView=document.getElementById("adminView");
const frontBtn=document.getElementById("frontBtn"),adminBtn=document.getElementById("adminBtn");
const scanInput=document.getElementById("scanInput"),frontTbody=document.querySelector("#frontTable tbody");
const adminTbody=document.querySelector("#adminTable tbody"),revChart=document.getElementById("revChart");
const toast=document.getElementById("toast"),cstClock=document.getElementById("cstClock");

/*** Toast + Clock ***/
function showToast(msg){toast.textContent=msg;toast.style.display="block";setTimeout(()=>toast.style.display="none",1200)}
function tickClock(){cstClock.textContent=nowCST().toLocaleTimeString("en-US",{hour12:false});}
setInterval(tickClock,1000);tickClock();

/*** renderers ***/
function renderFront(){
  const map=new Map();sales.forEach(s=>{map.set(s.barcode,(map.get(s.barcode)||0)+s.qty)});
  frontTbody.innerHTML="";
  inventory.forEach(p=>{
    const sold=map.get(p.barcode)||0;const end=Math.max(0,p.startingInventory-sold);
    const rev=(p.priceSold||0)*sold;
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${escapeHtml(p.name)}</td><td class="right">${currency(p.priceSold)}</td>
    <td class="right">${p.startingInventory}</td><td class="right">${sold}</td>
    <td class="right">${end}</td><td class="right">${currency(rev)}</td>`;
    frontTbody.appendChild(tr);
  });
}
function renderAdmin(){
  adminTbody.innerHTML="";
  inventory.forEach(p=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${escapeHtml(p.name)}</td><td>${escapeHtml(p.barcode)}</td>
    <td class="right">${currency(p.priceSold)}</td><td class="right">${currency(p.vendorCost)}</td>
    <td class="right">${p.startingInventory}</td>`;
    adminTbody.appendChild(tr);
  });
}

/*** Trend Chart ***/
function renderTrend(){
  const ctx=revChart.getContext("2d");ctx.clearRect(0,0,revChart.width,revChart.height);
  const daily={};sales.forEach(s=>{
    const day=shiftKeyCST(new Date(s.ts));
    daily[day]=(daily[day]||0)+ (s.qty*(inventory.find(p=>p.barcode==s.barcode)?.priceSold||0));
  });
  const days=Object.keys(daily).sort();
  if(!days.length){ctx.fillText("No data",10,20);return}
  const vals=days.map(d=>daily[d]);const max=Math.max(...vals,1);
  ctx.strokeStyle="#28a745";ctx.beginPath();
  days.forEach((d,i)=>{const x=60+i*60;const y=230-(vals[i]/max)*200;i?ctx.lineTo(x,y):ctx.moveTo(x,y);});
  ctx.stroke();
  ctx.fillStyle="#000";ctx.font="12px Arial";
  days.forEach((d,i)=>ctx.fillText(d.slice(5),55+i*60,245));
  ctx.fillText("Revenue Trend",10,15);
}

/*** Scanning ***/
let buffer="",bufTimer=null;
document.addEventListener("keydown",e=>{
  if(adminView.style.display==="block")return;
  if(e.key==="Enter"){const code=buffer.trim();buffer="";
    if(code){registerScan(code)};return;}
  if(e.key.length===1){buffer+=e.key;clearTimeout(bufTimer);bufTimer=setTimeout(()=>buffer="",100);}
});
scanInput.addEventListener("click",()=>showToast("Ready to scan..."));
function registerScan(code){
  const prod=inventory.find(p=>String(p.barcode).trim()==String(code).trim());
  if(!prod){showToast("Unknown barcode: "+code);return;}
  const now=new Date();
  sales.push({id:crypto.randomUUID(),barcode:code,qty:1,ts:now.toISOString()});
  saveJSON(LS_SALES,sales);
  renderFront();renderTrend();
  document.getElementById("lastScan").textContent=`Scanned: ${prod.name}`;
}

/*** Tabs ***/
frontBtn.onclick=()=>{frontView.style.display="block";adminView.style.display="none";}
adminBtn.onclick=()=>{frontView.style.display="none";adminView.style.display="block";renderAdmin();renderTrend();}

/*** Export CSV ***/
document.getElementById("exportCSV").onclick=()=>{
  const headers=["barcode","name","priceSold","vendorCost","startingInventory"];
  const body=inventory.map(p=>[p.barcode,p.name,p.priceSold,p.vendorCost,p.startingInventory].join(",")).join("\n");
  const blob=new Blob([headers.join(",")+"\n"+body],{type:"text/csv"});const url=URL.createObjectURL(blob);
  const a=document.createElement("a");a.href=url;a.download="inventory.csv";a.click();URL.revokeObjectURL(url);
}

/*** Test email button ***/
document.getElementById("testEmail").onclick=()=>{
  const url=localStorage.getItem(LS_GAS)||prompt("Enter your Apps Script web app URL:");
  if(!url)return;fetch(url+"?ping=1").then(()=>alert("Now open Apps Script and run emailYesterdayAndRoll() manually to test email."));
}

/*** init ***/
renderFront();renderAdmin();renderTrend();
</script>
</body>
</html>
